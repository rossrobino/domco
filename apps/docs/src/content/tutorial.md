## Tutorial

### Create

To get started, you'll need to have [Node.js](https://nodejs.org) or another server side JavaScript runtime installed on your computer.

Run this command in your terminal and follow the instructions provided.

```bash
npm create domco@latest
```

This command creates files in your project's directory instead of having to manually set up the plugin with Vite.

The following documentation covers the basics of creating a site and all of the features **domco** provides in addition to Vite and Hono. See the [Vite](https://vitejs.dev/) or [Hono](https://hono.dev) documentation for more information and configuration options.

### +page

Your project is located in `src/`---this serves as the root directory of your project. `src/+page.html` can be accessed at `https://example.com`, while `src/nested/+page.html` can be accessed at `https://example.com/nested`.

To create another page, add another `+page.html` file in another directory within `src/`.

**domco** configures Vite to process each `+page.html` as a separate entry point automatically. Everything linked in these pages will be bundled and included in the output upon running `vite build`.

For example, to add the `/nested` page, add `src/nested/+page.html`.

```diff
.
└── src/
	├── +page.html
	└── nested/
+		└── +page.html
```

Now you can navigate to `/nested` with an anchor tag.

```html
<a href="/nested">Nested</a>
```

### +client

Each `+client.(js,ts,jsx,tsx)` file within `src/` will be processed as an entry point by Vite. Client-side scripts can be used in pages and on the server without a page.

**domco** will automatically inject a tag for any `+client` file that is located next to a `+page.html` into the page so you don't need to link it.

```diff
.
└── src/
+	├── +client.ts - linked automatically
	└── +page.html
```

If you would like to like to add another script, you can import it into the `+client` entry, or add a script tag to your HTML page.

```html
<!-- +page.html -->
<script type="module" src="/some-other-script.ts"></script>
```

Now that this script is included in an entry point `+page.html`, the script, and anything that is imported, will be bundled and included in the final build.

### +server

Turn any path in `src` into a Hono app by adding a `+server.(js,ts,jsx,tsx)` file.

```diff
.
└── src/
	├── +page.html
+	└── +server.ts
```

You have now converted this route path from a static page into a Hono application based at that path.

```ts
// src/+server.ts
import { Hono } from "hono";

const app = new Hono();

app.get("/", (c) => c.html("hello world");

// you can also create another route from here
// this route can be accessed at https://example.com/another-route
app.get("/another-route", (c) => c.html("another route");

export default app;
```

#### Page context

**domco** sets a `page` context variable for you that will return the transformed output of any `+page.html` requested.

```ts
app.get("/", (c) => {
	// ./+page.html
	const page = c.var.page();

	// src/nested/+page.html
	const anotherPage = c.var.page("/nested");

	return c.html(page);
};
```

#### Client context

You can also easily get the tags for any `+client` file on the server as well. These script tags (including all imports) can be accessed using the `client` context variable within your Hono application. They can be included in an HTML string, or inside of JSX.

```ts
app.get("/", (c) => {
	// gets `./+client.(js,ts,jsx,tsx)`
	const tags = c.var.client();

	// gets `src/route/path/+client.(js,ts,jsx,tsx)`
	const differentTags = c.var.client("/route/path");

	return c.html(html`
		${tags}
		<p>Partial with client side script</p>
	`);
});
```

**domco** reads the manifest generated by the client build and includes the hashed version of these file names in production.

#### Server context

**domco** also sets a `server` context variable to make it easier to request local routes (it's just `fetch` with the `origin` set.)

```ts
// dev: fetch("http://localhost:5173/route/path")
// prod: fetch("https://example.com/route/path")
const res = await c.var.server("/route/path");
```

#### Prerender

You can export a `prerender` variable to prerender pages.

```ts
// src/posts/+server.ts
import type { Prerender } from "domco";

// prerender current route
export const prerender: Prerender = true;

// prerender multiple paths relative to the current route.
export const prerender: Prerender = ["/", "/post-1", "/post-2"];
```

#### Route ordering

Routes are sorted and applied from most specific to least.

```
.
└── src/
	├── +server.ts - 3rd
	└── nested/
		├── +server.ts - 2nd
		└── another/
			└── +server.ts - 1st
```

So if you write a handler within `src/nested/+server.ts` to handle requests for `"/"`, and also one inside `src/+server.ts` to handle `"/nested"`, the handler within `src/+server.ts` will never execute.

#### +setup

You can also create a `src/+setup.(js,ts,jsx,tsx)` file, this app will be added to your application before other routes. This is an escape hatch, for example if you need some middleware to apply to all routes in your application and you don't want to import it into each one.

### Styles

Styles can be linked to an HTML page using the `link` tag within the `head` tag, or by importing a stylesheet into a client side script.

Notice that the `href` for these links are relative to the root directory---this tag will link `src/style.css`.

```html
<!-- +page.html -->
<head>
	<link rel="stylesheet" href="/style.css" />
</head>
```

```js
// +client.js
import "/style.css";
```

## Migrate

This section will show you how to migrate an existing Vite single page application to become a Hono application. It will use the React template created when running `npm create vite`.

- Run `npm i -D hono domco` in your terminal to install hono and domco as dependencies.
- Add `domco` to your `plugins` array in your `vite.config`.

```ts
// vite.config.ts
import react from "@vitejs/plugin-react";
import { domco } from "domco";
import { defineConfig } from "vite";

// https://vitejs.dev/config/
export default defineConfig({
	plugins: [domco(), react()],
});
```

- Add types to `/src/vite.env.d.ts`

```ts
// /src/vite.env.d.ts
/// <reference types="vite/client" />
import type { DomcoContextVariableMap } from "domco";
import "hono";

declare module "hono" {
	interface ContextVariableMap extends DomcoContextVariableMap {}
}
```

- Move `index.html` into `src/` and rename it to `+page.html`.
- Change the `src` attribute of the `script` tag linking to `/src/main.tsx` to `/main.tsx` (alternatively remove the tag entirely and rename `main.tsx` to `+client.tsx`).
- Run `npm run dev` to serve your application - done!
- Now, to add an API route, create a `+server.ts` file anywhere within `src/`. In this example, we can make `/src/+server.ts` and serve the app from an endpoint.

```ts
// /src/+server.ts
import { Hono } from "hono";

const app = new Hono();

app.get("/", (c) => c.html(c.var.page());
app.get("/api", (c) => c.html("hello world");

export default app;
```

- `/` is now an API route serving your React SPA application.
- Navigate to `/api` to see the `"hello world"` response from your API.

## Deploy

Run `vite build` to build your application into `dist/`.

```
.
└── dist/
	├── client/
	│	├── _immutable/
	│	└── index.html
	└── server/
		├── app.js
		├── (main.js)
		└── node.js
```

By default **domco** will generate a NodeJS server and static assets for your application. You can also use an [adapter](#adapters) or export your app to configure it to use in [another environment](https://hono.dev/docs/getting-started/basic).

The `client/` directory holds client assets. JS and CSS assets with hashed file names will automatically be served with immutable cache headers from `dist/client/_immutable`. Other assets are processed and included in `dist/client` directly.

The `server/` directory has three entry points:

- `app.js` exports your Hono server. You can import it in another file and deploy your app to a variety of [platforms](https://hono.dev/docs/getting-started/basic) manually. No NodeJS specific APIs are used in the `app.js` export.
- `main.js` is the main entry point for your application if you used an adapter, configured to the target environment.
- `node.js` is a NodeJS build of your application. You can run `dist/server/node.js` to run your application or preview it if you are using an adapter.

### Adapters

If you need to deploy to a different environment than static/NodeJs, you can add a deployment adapter within your Vite config to output your app to a different target with no additional configuration.

```ts diff
// vite.config
import { domco } from "domco";
// import adapter
import { adapter } from "domco/adapter/vercel";
import { defineConfig } from "vite";

export default defineConfig({
	plugins: [
		domco({
			// add to your domco config
			adapter: adapter({
				// options...
			}),
		}),
	],
});
```

#### Vercel

The Vercel adapter outputs your app to Vercel's [Build Output API](https://vercel.com/docs/build-output-api/v3) specification.

- Supports Serverless (+ ISR), and Edge Runtime.
- Outputs public assets to be served on Vercel's CDN. Since your application will not be serving these assets, if you want to protect a page, you need to serve it from an endpoint instead.
